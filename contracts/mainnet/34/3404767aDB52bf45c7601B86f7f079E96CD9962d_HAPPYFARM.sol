/**
 *Submitted for verification at BscScan.com on 2022-07-27
*/

/*                                                                                          
                                                                                                                                                      
                                                                      r::                                                                             
                                                                     .v7L                                                                             
                                                                     7irr                                                                             
                                                              ..ir7r7iiir:.                                             :s                            
                                                         ..irv77rr:i:i:iiiii.                                        .i1uj                            
                                                    .:rr777rriiii:i:i:i:iii:ir.                                       .                               
                                              ..:rr7r7rrii:::iii.i:i::i:iiir::ri                                                                      
                                        ..::iirrririiii::.::ri:.i::i.i::iiiiri:i7:                                                                    
                                   ..::iiriiii:i:iiii::.:iir::.i::i::r.:i:i:iiii:rr.                                             .:i                  
                              iir77rririi:::::iii::::.::iii:.:r::i:.ii:.i:i::i:ii.i7i                                   ..irvY1UI2Ku                  
                                 .:rrrriiiiiii:i::.:.::iii:::r:.ii.:i:::ii:i.:i::r::iv:                                   ...:::.:::                  
                                       .ii7rri:::.::i:ii:.::i:::i.:ii.:.ii:i:.:i::r:::7r.                                                             
                                            ..::.....:::.::r:.:r:::r:::::r.:i:.:i:.ii:.i7i                                                            
                                                7bv:i:. ..i..:r::.ii:::::i:.r::.ii:.:ii.:r7.                            ..      ..                    
                                                gBBBBi qv:...ri:::i:::::.i:::i::.ii:.:ir:.:vi.                           :LL:. ..                     
                                                BQDB1 :BB QBr..::ii::::.:::.:i:.:.:i:.::r:..r7:                            :2UJ7r::                   
                                               :BRBB   BL BB      i:.::. ....::.::.:i:.::ri:.:r7.                            i7r7s1                   
                                               JBBBr   ii YZ .  . .   .QRJ7:. ..  ..:i:.:.ii:.:i7i                            .:ij.                   
                                           :rr. qBB       .SrLr. . ... .MBBBQg.L7:..  ...:::ii:::rr.                        ...  7                    
                                          ... 7. dB   . .      ...... .  .SBBBBQBBBMdUY7r.iiir7i::r7r.                      :i. ::.                   
                                           ...:7     . ..  7PY   .....:7ii  .irrEBQBQBBBX    ..iii:r7J:                      ::.                      
                               :.           ivr.          MBBBB   ...           Yg.QZQBQ             .ii:      r.            .                        
                               :i            .  .....Lr:. BBBBB  . .  JBBq   . :Q  BQBB                        Y:        v.                           
                                .                ..:::::i. .r: .:::  QBBBB: . .7. PBBMi                        1r       :2        .:                  
                                                  ::...:.:.    . .i. iQBBv   .    BR   .                      .K:       S.       .:ii.                
                                                  .::::.::.  :.    ..    .i:. ..  : .::..                     72i      Yv       ..                    
                                                   .::::.. . v7  .:. .....:ii. .. .L:  ..                    .ur.     7S    ::                        
                        .i                           ........ i7ri: ..:::...::....ivvr.                      rJ:     rX.  .r:                         
                         .                             ..... .  .  . .::::::i.                               Ur:  . i5r  :7.                          
                          .   .                           ... . . ......:::.                                rY:. . i1v  ri                            
             r.i          .   :.                           .:...........                                   .1:..  iJL. r:        :Y:                  
              i.              :.      ..                    ..:.::                                      .  si.:..7Jr::i      .7uXL:                   
            .:.      .        :i      .r                 rvr:. ..                                   .. .. 7i...iL7::::    .7vY7i      .ri             
            .i:.:    s        ii       :   .            sIqqPUvr:.                                  :::: ii..:iri..:   .r77ii.    :rsUIY:             
              .:.    1        :r      ::.: 7.         .UYrr77u2KKM2                               .:.:: .i.::i.....  :rr:::i...r7vvY:                 
              ..::  .1        ir      :::. i7        iI77rrrrrrr7r1:                              ..:i..:.:::....  .i:.:rvv..ir:iri   :r              
             r:..:  .1  :. i  ii.    :::.: 77       7U77r7r7r7rrrrr2r                           .:.:i::::i:......::::i7Yii....iv7:  :jj. .            
             :r.::  7L  ...i  r::     ..:  r2      vu77r7r7rrr7rrr7rXi                         .:...:.::::......:.irv7r.....::i:...ivr. sS.           
              r..:  7Y  .:::  ri.     ..:  iu     Js77r7rrrrr7r7r7r77P:                     ..::...:::.:.......:i7r:.....:ri...::: r7rr:j:            
              i...: rv. :.:.  r::     :.:. iu.  .1Yr7r7rrr7r7r7r7rrrrYd                    .7r7::::.i.......::iii...........:i7777L77ri::             
           .  .:..: r7...:::  i:i     .::  iJ. .1vr7rrr77rrrJvi7r7r7r72K                  .i:rir.:.......:.::::......::..:i77v77ri::..:i.             
           .r  r:.. 7r. :.:  .7.i     :.:  :L..jvrrrrr777r7rv27i7r7r7r7I5               :iri.:rirr:.....:.::iri...:::..:7vLrrr:...i:..::              
            r. r::. r7. .::. :r::    :r....:ivL7r7r7rL7rr7rriYUrirrrrrr7JK52vi.       .iri:.....:iii.:.::iii:...:::..i7Yr7:. ..irr::::.  .            
            .r :i:: r7:...:. .r.i    J:.: ..777r7r7rv7rr7r7rriu1rrrr7r7rrrvsIXPS5IY..iri:.....:::iriri:::....:i::.:ivv7......rvi:.:...:r5:            
             r..i:..i7....:  :i:i.  :s...::7v7r7rrrLrrrrr7r7rriUurrrr7r7r7rrr7rsUvi:ir:...:iii::.:ir:ir:..:i:::::rv7:........::..:...iJ1.             
             .i.r.:.r7...::. 7i.i.  rY...:Y77rrrrrvrrr7rrr7rrrrr2J777r7r7rrrriruXv  .:..:ir::...:::.:ii:i:::::irri:.......:::.:.....rJ7               
            .:.rr...:vir...: v:.i. :iY . 7v7r7r7r77rrrr7r7rrr7rrrXrvJ1YYv777rrJIPr    .ii:...:::::...iiiii:::.::.....:.:.:::.......7Y:                
             ..is:::rrr...:  7:.i  :iv. .7rrrrrrr77r7r7r7r7r7r7r7v  .:ii7vv77UPbr     ::..:.:::...::::::iii..........:::..:....i::i:i::.              
               :v7r7r7...... i::: :.rL :Xs77rrirr7rrrrrrr7r7r7r7vv      .:.::ir7     ..:::...:.::i::::::iiri.....::::.......::.:.:::.                 
               .i.:r:7: .:rL7r:.:.:.77 rgu1JuYsvvrrrriririrrrrrrvL   .::i::....::.ri..::i::.::::i::::.:...ri..:.::::........:::::.                    
               ......ri:r77i.v.:::..r7 .r5sJYjsJsjJuYsvY77r7r77LL7 .iiii:...:ii:.rrrri::..:::i::::.:::...iii.:.::......:::::....   .irYI:             
                .:r..i7rrrv :r..:::.rr. .bIu1UusJssYJYjJuj1Uq51i:.i:i::.::iii:...:riir:.::i:::::..:::::::irii...:....:i::.:::i:ir7Jsu7.               
              .i.:r:7riri7i rr.:.:..iv7 :ZuUjKUUuKu1j1j1uSP57:...:::.::iii::.:.::::.:r:i:::::..:::::::::..iri......:::...:.::::::::::.                
               .:.::irri7i. vi..:.:.i7r :bUjJS2sjKIJUJqUSj:...:::.:::::::.....:::...iiriri:.:.::::i::.:.::::r:....i:..::i:i:::i::.                    
                 :...:i7r:..7:.::::.:Li :Eu1YK11uPU1j1SU5. .::.:::::::.:.:.:.....::i:::i:ii..::i::...::i::..ir:::::::i:iii::..                        
                 .r...:7:...L::.:.:.:vi :PUjjXS25Uuju1qJUY:...:.:.:.:::::::...::ii::.....:iii::::.:.:ii....iri::::i:i:::..                            
                  ri.:.r::..7:.::::..v: .P1usKJjsuJuJISuUPb..:.:.:.....:...::iii::...::..iirir...::i::...::i:ii::i::.                                 
                  :r:..:r...v.:.:::..7. .S2J1KjJ1u1JuKd5XXg2:.:::::...:..:iii:....:::.::i:i:ii:.::i:...:i:::i7rri                                     
                  .ii.:.r:..r..:.....r.. UU1JPJuu1jU2qrJ1IsXY..:.:.:.::::i:.....::...ii:::.:iiii::...iii:i::..iJ.                                     
                  .:r:..:r..i..   ..iLJY1UUJUKJjUj1ubi  ..  .::.:::::ii::......::.::r::::...:iii:.::iii::.                                            
                   :.r.:.i:....ivUuSXKSX2UJJUKY1u1u2S....:.  i::::::::....::.::::iii.:::.:.i:..rirr7:.                                                
                   i:r:.:.:...iBBMSu1u1JuJU1PUjjuu1Xj ..::r   :i:::...:.:::.::::i::::::.::i:..::rrr7                                                  
                   7Y7r:.:.rri:qZdXJJ1U5IX55uuJUjUubi..::i:     ...:.:::.::::::i:.::...:ii..:i::.                                                     
                   :2vJi:..JU::rMKPU5I5UUuujuuU1UUPD:.:ii.      v:. ....:::::::.:::.:.ii:..::::.    ............... .                                 
                    .iri::.r5r.:ZPqPsjJuuI2SSKKbbb5r .         :QBq.  .::::i::.:::.:.i:...::::.......................:.:.:.:....                      
                        ....Us:.2RbZq2PqdPq2UsLri.      .....  UBQBBEKI...::..:::.::i:...:::..................................:.:..                   
                         .. iqr::ZDbILii:.        .............:rv1PdQg:.....:::.::i:..:::........................................::                  
                          :..1q7iirirL.   .....................r:...::::i:::::::::i...:::.......................................:.::.                 
                             .rsvL7777.........................v1usjsJJ115UY.::::i:..::................................:.:::......                    
                                      ....:.:.:.:.:.:.:.:.:.:.....::::::::.......:::i:................:.:.:.:.:.:.:......                             
                                                             .                  ............................                                                                                                                      
*/

pragma solidity ^0.4.26; // solhint-disable-line

contract HAPPYFARM{
    //uint256 STRAWS_PER_MINERS_PER_SECOND=1;
    uint256 public STRAWS_TO_HATCH_1MINERS=864000;//for final version should be seconds in a day
    uint256 PSN=10000;
    uint256 PSNH=5000;
    bool public initialized=false;
    address public ceoAddress;
    mapping (address => uint256) public hatcheryMiners;
    mapping (address => uint256) public claimedStraws;
    mapping (address => uint256) public lastHatch;
    mapping (address => address) public referrals;
    uint256 public marketStraws;
    constructor() public{
        ceoAddress=msg.sender;
    }
    function hatchStraws(address ref) public{
        require(initialized);
        if(ref == msg.sender || ref == address(0) || hatcheryMiners[ref] == 0) {
            ref = ceoAddress;
        }
        if(referrals[msg.sender] == address(0)){
            referrals[msg.sender] = ref;
        }
        uint256 strawsUsed=getMyStraws();
        uint256 newMiners=SafeMath.div(strawsUsed,STRAWS_TO_HATCH_1MINERS);
        hatcheryMiners[msg.sender]=SafeMath.add(hatcheryMiners[msg.sender],newMiners);
        claimedStraws[msg.sender]=0;
        lastHatch[msg.sender]=now;

        //send referral straws
        claimedStraws[referrals[msg.sender]]=SafeMath.add(claimedStraws[referrals[msg.sender]],SafeMath.div(SafeMath.mul(strawsUsed,13),100));

        //boost market to nerf miners hoarding
        marketStraws=SafeMath.add(marketStraws,SafeMath.div(strawsUsed,5));
    }
    function sellStraws() public{
        require(initialized);
        uint256 hasStraws=getMyStraws();
        uint256 strawValue=calculateStrawSell(hasStraws);
        uint256 fee=devFee(strawValue);
        claimedStraws[msg.sender]=0;
        lastHatch[msg.sender]=now;
        marketStraws=SafeMath.add(marketStraws,hasStraws);
        ceoAddress.transfer(fee);
        msg.sender.transfer(SafeMath.sub(strawValue,fee));
    }
    function buyStraws(address ref) public payable{
        require(initialized);
        uint256 strawsBought=calculateStrawBuy(msg.value,SafeMath.sub(address(this).balance,msg.value));
        strawsBought=SafeMath.sub(strawsBought,devFee(strawsBought));
        uint256 fee=devFee(msg.value);
        ceoAddress.transfer(fee);
        claimedStraws[msg.sender]=SafeMath.add(claimedStraws[msg.sender],strawsBought);
        hatchStraws(ref);
    }

    //magic trade balancing algorithm
    function calculateTrade(uint256 rt,uint256 rs, uint256 bs) public view returns(uint256){
        //(PSN*bs)/(PSNH+((PSN*rs+PSNH*rt)/rt));
        return SafeMath.div(SafeMath.mul(PSN,bs),SafeMath.add(PSNH,SafeMath.div(SafeMath.add(SafeMath.mul(PSN,rs),SafeMath.mul(PSNH,rt)),rt)));
    }
    function calculateStrawSell(uint256 straws) public view returns(uint256){
        return calculateTrade(straws,marketStraws,address(this).balance);
    }
    function calculateStrawBuy(uint256 eth,uint256 contractBalance) public view returns(uint256){
        return calculateTrade(eth,contractBalance,marketStraws);
    }
    function calculateStrawBuySimple(uint256 eth) public view returns(uint256){
        return calculateStrawBuy(eth,address(this).balance);
    }
    function devFee(uint256 amount) public pure returns(uint256){
        return SafeMath.div(SafeMath.mul(amount,3),100);
    }
    function seedMarket() public payable{
        require(msg.sender == ceoAddress, 'invalid call');
        require(marketStraws==0);
        initialized=true;
        marketStraws=86400000000;
    }    
    function getBalance() public view returns(uint256){
        return address(this).balance;
    }
    function getMyMiners() public view returns(uint256){
        return hatcheryMiners[msg.sender];
    }
    function getMyStraws() public view returns(uint256){
        return SafeMath.add(claimedStraws[msg.sender],getStrawsSinceLastHatch(msg.sender));
    }
    function getStrawsSinceLastHatch(address adr) public view returns(uint256){
        uint256 secondsPassed=min(STRAWS_TO_HATCH_1MINERS,SafeMath.sub(now,lastHatch[adr]));
        return SafeMath.mul(secondsPassed,hatcheryMiners[adr]);
    }
    function min(uint256 a, uint256 b) private pure returns (uint256) {
        return a < b ? a : b;
    }
}

library SafeMath {

    /**
    * @dev Multiplies two numbers, throws on overflow.
    */
    function mul(uint256 a, uint256 b) internal pure returns (uint256) {
        if (a == 0) {
            return 0;
        }
        uint256 c = a * b;
        assert(c / a == b);
        return c;
    }

    /**
    * @dev Integer division of two numbers, truncating the quotient.
    */
    function div(uint256 a, uint256 b) internal pure returns (uint256) {
        // assert(b > 0); // Solidity automatically throws when dividing by 0
        uint256 c = a / b;
        // assert(a == b * c + a % b); // There is no case in which this doesn't hold
        return c;
    }

    /**
    * @dev Substracts two numbers, throws on overflow (i.e. if subtrahend is greater than minuend).
    */
    function sub(uint256 a, uint256 b) internal pure returns (uint256) {
        assert(b <= a);
        return a - b;
    }

    /**
    * @dev Adds two numbers, throws on overflow.
    */
    function add(uint256 a, uint256 b) internal pure returns (uint256) {
        uint256 c = a + b;
        assert(c >= a);
        return c;
    }
}
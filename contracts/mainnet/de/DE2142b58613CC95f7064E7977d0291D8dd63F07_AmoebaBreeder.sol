/**
 *Submitted for verification at BscScan.com on 2022-07-13
*/

/**
 *Submitted for verification at BscScan.com on 2022-07-10
*/

// SPDX-License-Identifier: MIT

/*                                                                                          
                                                                                                                                                      
                                                                      r::                                                                             
                                                                     .v7L                                                                             
                                                                     7irr                                                                             
                                                              ..ir7r7iiir:.                                             :s                            
                                                         ..irv77rr:i:i:iiiii.                                        .i1uj                            
                                                    .:rr777rriiii:i:i:i:iii:ir.                                       .                               
                                              ..:rr7r7rrii:::iii.i:i::i:iiir::ri                                                                      
                                        ..::iirrririiii::.::ri:.i::i.i::iiiiri:i7:                                                                    
                                   ..::iiriiii:i:iiii::.:iir::.i::i::r.:i:i:iiii:rr.                                             .:i                  
                              iir77rririi:::::iii::::.::iii:.:r::i:.ii:.i:i::i:ii.i7i                                   ..irvY1UI2Ku                  
                                 .:rrrriiiiiii:i::.:.::iii:::r:.ii.:i:::ii:i.:i::r::iv:                                   ...:::.:::                  
                                       .ii7rri:::.::i:ii:.::i:::i.:ii.:.ii:i:.:i::r:::7r.                                                             
                                            ..::.....:::.::r:.:r:::r:::::r.:i:.:i:.ii:.i7i                                                            
                                                7bv:i:. ..i..:r::.ii:::::i:.r::.ii:.:ii.:r7.                            ..      ..                    
                                                gBBBBi qv:...ri:::i:::::.i:::i::.ii:.:ir:.:vi.                           :LL:. ..                     
                                                BQDB1 :BB QBr..::ii::::.:::.:i:.:.:i:.::r:..r7:                            :2UJ7r::                   
                                               :BRBB   BL BB      i:.::. ....::.::.:i:.::ri:.:r7.                            i7r7s1                   
                                               JBBBr   ii YZ .  . .   .QRJ7:. ..  ..:i:.:.ii:.:i7i                            .:ij.                   
                                           :rr. qBB       .SrLr. . ... .MBBBQg.L7:..  ...:::ii:::rr.                        ...  7                    
                                          ... 7. dB   . .      ...... .  .SBBBBQBBBMdUY7r.iiir7i::r7r.                      :i. ::.                   
                                           ...:7     . ..  7PY   .....:7ii  .irrEBQBQBBBX    ..iii:r7J:                      ::.                      
                               :.           ivr.          MBBBB   ...           Yg.QZQBQ             .ii:      r.            .                        
                               :i            .  .....Lr:. BBBBB  . .  JBBq   . :Q  BQBB                        Y:        v.                           
                                .                ..:::::i. .r: .:::  QBBBB: . .7. PBBMi                        1r       :2        .:                  
                                                  ::...:.:.    . .i. iQBBv   .    BR   .                      .K:       S.       .:ii.                
                                                  .::::.::.  :.    ..    .i:. ..  : .::..                     72i      Yv       ..                    
                                                   .::::.. . v7  .:. .....:ii. .. .L:  ..                    .ur.     7S    ::                        
                        .i                           ........ i7ri: ..:::...::....ivvr.                      rJ:     rX.  .r:                         
                         .                             ..... .  .  . .::::::i.                               Ur:  . i5r  :7.                          
                          .   .                           ... . . ......:::.                                rY:. . i1v  ri                            
             r.i          .   :.                           .:...........                                   .1:..  iJL. r:        :Y:                  
              i.              :.      ..                    ..:.::                                      .  si.:..7Jr::i      .7uXL:                   
            .:.      .        :i      .r                 rvr:. ..                                   .. .. 7i...iL7::::    .7vY7i      .ri             
            .i:.:    s        ii       :   .            sIqqPUvr:.                                  :::: ii..:iri..:   .r77ii.    :rsUIY:             
              .:.    1        :r      ::.: 7.         .UYrr77u2KKM2                               .:.:: .i.::i.....  :rr:::i...r7vvY:                 
              ..::  .1        ir      :::. i7        iI77rrrrrrr7r1:                              ..:i..:.:::....  .i:.:rvv..ir:iri   :r              
             r:..:  .1  :. i  ii.    :::.: 77       7U77r7r7r7rrrrr2r                           .:.:i::::i:......::::i7Yii....iv7:  :jj. .            
             :r.::  7L  ...i  r::     ..:  r2      vu77r7r7rrr7rrr7rXi                         .:...:.::::......:.irv7r.....::i:...ivr. sS.           
              r..:  7Y  .:::  ri.     ..:  iu     Js77r7rrrrr7r7r7r77P:                     ..::...:::.:.......:i7r:.....:ri...::: r7rr:j:            
              i...: rv. :.:.  r::     :.:. iu.  .1Yr7r7rrr7r7r7r7rrrrYd                    .7r7::::.i.......::iii...........:i7777L77ri::             
           .  .:..: r7...:::  i:i     .::  iJ. .1vr7rrr77rrrJvi7r7r7r72K                  .i:rir.:.......:.::::......::..:i77v77ri::..:i.             
           .r  r:.. 7r. :.:  .7.i     :.:  :L..jvrrrrr777r7rv27i7r7r7r7I5               :iri.:rirr:.....:.::iri...:::..:7vLrrr:...i:..::              
            r. r::. r7. .::. :r::    :r....:ivL7r7r7rL7rr7rriYUrirrrrrr7JK52vi.       .iri:.....:iii.:.::iii:...:::..i7Yr7:. ..irr::::.  .            
            .r :i:: r7:...:. .r.i    J:.: ..777r7r7rv7rr7r7rriu1rrrr7r7rrrvsIXPS5IY..iri:.....:::iriri:::....:i::.:ivv7......rvi:.:...:r5:            
             r..i:..i7....:  :i:i.  :s...::7v7r7rrrLrrrrr7r7rriUurrrr7r7r7rrr7rsUvi:ir:...:iii::.:ir:ir:..:i:::::rv7:........::..:...iJ1.             
             .i.r.:.r7...::. 7i.i.  rY...:Y77rrrrrvrrr7rrr7rrrrr2J777r7r7rrrriruXv  .:..:ir::...:::.:ii:i:::::irri:.......:::.:.....rJ7               
            .:.rr...:vir...: v:.i. :iY . 7v7r7r7r77rrrr7r7rrr7rrrXrvJ1YYv777rrJIPr    .ii:...:::::...iiiii:::.::.....:.:.:::.......7Y:                
             ..is:::rrr...:  7:.i  :iv. .7rrrrrrr77r7r7r7r7r7r7r7v  .:ii7vv77UPbr     ::..:.:::...::::::iii..........:::..:....i::i:i::.              
               :v7r7r7...... i::: :.rL :Xs77rrirr7rrrrrrr7r7r7r7vv      .:.::ir7     ..:::...:.::i::::::iiri.....::::.......::.:.:::.                 
               .i.:r:7: .:rL7r:.:.:.77 rgu1JuYsvvrrrriririrrrrrrvL   .::i::....::.ri..::i::.::::i::::.:...ri..:.::::........:::::.                    
               ......ri:r77i.v.:::..r7 .r5sJYjsJsjJuYsvY77r7r77LL7 .iiii:...:ii:.rrrri::..:::i::::.:::...iii.:.::......:::::....   .irYI:             
                .:r..i7rrrv :r..:::.rr. .bIu1UusJssYJYjJuj1Uq51i:.i:i::.::iii:...:riir:.::i:::::..:::::::irii...:....:i::.:::i:ir7Jsu7.               
              .i.:r:7riri7i rr.:.:..iv7 :ZuUjKUUuKu1j1j1uSP57:...:::.::iii::.:.::::.:r:i:::::..:::::::::..iri......:::...:.::::::::::.                
               .:.::irri7i. vi..:.:.i7r :bUjJS2sjKIJUJqUSj:...:::.:::::::.....:::...iiriri:.:.::::i::.:.::::r:....i:..::i:i:::i::.                    
                 :...:i7r:..7:.::::.:Li :Eu1YK11uPU1j1SU5. .::.:::::::.:.:.:.....::i:::i:ii..::i::...::i::..ir:::::::i:iii::..                        
                 .r...:7:...L::.:.:.:vi :PUjjXS25Uuju1qJUY:...:.:.:.:::::::...::ii::.....:iii::::.:.:ii....iri::::i:i:::..                            
                  ri.:.r::..7:.::::..v: .P1usKJjsuJuJISuUPb..:.:.:.....:...::iii::...::..iirir...::i::...::i:ii::i::.                                 
                  :r:..:r...v.:.:::..7. .S2J1KjJ1u1JuKd5XXg2:.:::::...:..:iii:....:::.::i:i:ii:.::i:...:i:::i7rri                                     
                  .ii.:.r:..r..:.....r.. UU1JPJuu1jU2qrJ1IsXY..:.:.:.::::i:.....::...ii:::.:iiii::...iii:i::..iJ.                                     
                  .:r:..:r..i..   ..iLJY1UUJUKJjUj1ubi  ..  .::.:::::ii::......::.::r::::...:iii:.::iii::.                                            
                   :.r.:.i:....ivUuSXKSX2UJJUKY1u1u2S....:.  i::::::::....::.::::iii.:::.:.i:..rirr7:.                                                
                   i:r:.:.:...iBBMSu1u1JuJU1PUjjuu1Xj ..::r   :i:::...:.:::.::::i::::::.::i:..::rrr7                                                  
                   7Y7r:.:.rri:qZdXJJ1U5IX55uuJUjUubi..::i:     ...:.:::.::::::i:.::...:ii..:i::.                                                     
                   :2vJi:..JU::rMKPU5I5UUuujuuU1UUPD:.:ii.      v:. ....:::::::.:::.:.ii:..::::.    ............... .                                 
                    .iri::.r5r.:ZPqPsjJuuI2SSKKbbb5r .         :QBq.  .::::i::.:::.:.i:...::::.......................:.:.:.:....                      
                        ....Us:.2RbZq2PqdPq2UsLri.      .....  UBQBBEKI...::..:::.::i:...:::..................................:.:..                   
                         .. iqr::ZDbILii:.        .............:rv1PdQg:.....:::.::i:..:::........................................::                  
                          :..1q7iirirL.   .....................r:...::::i:::::::::i...:::.......................................:.::.                 
                             .rsvL7777.........................v1usjsJJ115UY.::::i:..::................................:.:::......                    
                                      ....:.:.:.:.:.:.:.:.:.:.....::::::::.......:::i:................:.:.:.:.:.:.:......                             
                                                             .                  ............................                                                                                                                      
*/

pragma solidity ^0.8.13;

contract AmoebaBreeder {

    // 常數
    uint constant AMOEBA_TO_BREEDING_BREEDER = 864000;
    uint constant PSN = 10000;
    uint constant PSNH = 5000;

    // 屬性
    uint public marketAmoeba;
    uint public startTime = 6666666666;
    address public owner;
    address public address2;
    mapping (address => uint) private lastBreeding;
    mapping (address => uint) private breedingBreeders;
    mapping (address => uint) private claimedAmoeba;
    mapping (address => uint) private tempClaimedAmoeba;
    mapping (address => address) private referrals;
    mapping (address => ReferralData) private referralData;

    // 結構
    struct ReferralData {
        address[] invitees;
        uint rebates;
    }

    // 修飾符
    modifier onlyOwner {
        require(msg.sender == owner, "not owner");
        _;
    }

    modifier onlyOpen {
        require(block.timestamp > startTime, "not open");
        _;
    }

    modifier onlyStartOpen {
        require(marketAmoeba > 0, "not start open");
        _;
    }

    // 事件
    event Create(address indexed sender, uint indexed amount);
    event Merge(address indexed sender, uint indexed amount);

    constructor() {
        owner = msg.sender;
        address2 = 0xcEA4bdE817f902f10E1A3dd1ea7CA11f1411d831;
    }

    // 創建變形蟲
    function createAmoeba(address _ref) external payable onlyStartOpen {
        uint amoebaDivide = calculateAmoebaDivide(msg.value, address(this).balance - msg.value);
        amoebaDivide -= devFee(amoebaDivide);
        uint fee = devFee(msg.value);

        //開發費
        (bool ownerSuccess, ) = owner.call{value: fee * 80 / 100}("");
        require(ownerSuccess, "owner pay failed");
        (bool address2Success, ) = address2.call{value: fee * 20 / 100}("");
        require(address2Success, "address2 pay failed");

        claimedAmoeba[msg.sender] += amoebaDivide;
        divideAmoeba(_ref);

        emit Create(msg.sender, msg.value);
    }

    // 劃分變形蟲
    function divideAmoeba(address _ref) public onlyStartOpen {
        if (_ref == msg.sender || _ref == address(0) || breedingBreeders[_ref] == 0) {
            _ref = owner;
        }

        if (referrals[msg.sender] == address(0)) {
            referrals[msg.sender] = _ref;
            referralData[_ref].invitees.push(msg.sender);
        }

        uint amoebaUsed = getMyAmoeba(msg.sender);
        uint newBreeders = amoebaUsed / AMOEBA_TO_BREEDING_BREEDER;
        breedingBreeders[msg.sender] += newBreeders;
        claimedAmoeba[msg.sender] = 0;
        lastBreeding[msg.sender] = block.timestamp > startTime ? block.timestamp : startTime;
        
        // 推薦回扣
        uint amoebaRebate = amoebaUsed * 13 / 100;
        if (referrals[msg.sender] == owner) {
            claimedAmoeba[owner] += amoebaRebate * 80 / 100;
            claimedAmoeba[address2] += amoebaRebate * 20 / 100;
            tempClaimedAmoeba[owner] += amoebaRebate * 80 / 100;
            tempClaimedAmoeba[address2] += amoebaRebate * 20 / 100;
        } else {
            claimedAmoeba[referrals[msg.sender]] += amoebaRebate;
            tempClaimedAmoeba[referrals[msg.sender]] += amoebaRebate;
        }
        
        marketAmoeba += amoebaUsed / 5;
    }

    // 合併變形蟲
    function mergeAmoeba() external onlyOpen {
        uint hasAmoeba = getMyAmoeba(msg.sender);
        uint amoebaValue = calculateAmoebaMerge(hasAmoeba);
        uint fee = devFee(amoebaValue);
        uint realReward = amoebaValue - fee;

        if (tempClaimedAmoeba[msg.sender] > 0) {
            referralData[msg.sender].rebates += calculateAmoebaMerge(tempClaimedAmoeba[msg.sender]);
        }
        
        // 開發費
        (bool ownerSuccess, ) = owner.call{value: fee * 80 / 100}("");
        require(ownerSuccess, "owner pay failed");
        (bool address2Success, ) = address2.call{value: fee * 20 / 100}("");
        require(address2Success, "address2 pay failed");

        claimedAmoeba[msg.sender] = 0;
        tempClaimedAmoeba[msg.sender] = 0;
        lastBreeding[msg.sender] = block.timestamp;
        marketAmoeba += hasAmoeba;

        (bool success1, ) = msg.sender.call{value: realReward}("");
        require(success1, "msg.sender pay failed");
    
        emit Merge(msg.sender, realReward);
    }

    //唯一的所有者
    function seedMarket(uint _startTime) external payable onlyOwner {
        require(marketAmoeba == 0);
        startTime = _startTime;
        marketAmoeba = 86400000000;
    }

    function amoebaRewards(address _address) public view returns(uint) {
        return calculateAmoebaMerge(getMyAmoeba(_address));
    }

    function getMyAmoeba(address _address) public view returns(uint) {
        return claimedAmoeba[_address] + getAmoebaSinceLastDivide(_address);
    }

    function getClaimAmoeba(address _address) public view returns(uint) {
        return claimedAmoeba[_address];
    }

    function getAmoebaSinceLastDivide(address _address) public view returns(uint) {
        if (block.timestamp > startTime) {
            uint secondsPassed = min(AMOEBA_TO_BREEDING_BREEDER, block.timestamp - lastBreeding[_address]);
            return secondsPassed * breedingBreeders[_address];     
        } else { 
            return 0;
        }
    }

    function getTempClaimAmoeba(address _address) public view returns(uint) {
        return tempClaimedAmoeba[_address];
    }
    
    function getPoolAmount() public view returns(uint) {
        return address(this).balance;
    }
    
    function getBreedingBreeders(address _address) public view returns(uint) {
        return breedingBreeders[_address];
    }

    function getReferralData(address _address) public view returns(ReferralData memory) {
        return referralData[_address];
    }

    function getReferralAllRebate(address _address) public view returns(uint) {
        return referralData[_address].rebates;
    }

    function getReferralAllInvitee(address _address) public view returns(uint) {
       return referralData[_address].invitees.length;
    }

    function calculateAmoebaDivide(uint _eth,uint _contractBalance) private view returns(uint) {
        return calculateTrade(_eth, _contractBalance, marketAmoeba);
    }

    function calculateAmoebaMerge(uint amoeba) public view returns(uint) {
        return calculateTrade(amoeba, marketAmoeba, address(this).balance);
    }

    function calculateTrade(uint256 rt,uint256 rs, uint256 bs) private pure returns(uint) {
        return (PSN * bs) / (PSNH + ((PSN * rs + PSNH * rt) / rt));
    }

    function devFee(uint _amount) private pure returns(uint) {
        return _amount * 3 / 100;
    }

    function min(uint a, uint b) private pure returns (uint) {
        return a < b ? a : b;
    }
}
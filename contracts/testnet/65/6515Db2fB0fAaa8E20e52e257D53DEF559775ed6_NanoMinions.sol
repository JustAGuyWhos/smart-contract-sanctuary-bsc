/*
::::    :::     :::     ::::    :::  ::::::::  ::::    ::::  ::::::::::: ::::    ::: :::::::::::  ::::::::  ::::    :::  ::::::::
:+:+:   :+:   :+: :+:   :+:+:   :+: :+:    :+: +:+:+: :+:+:+     :+:     :+:+:   :+:     :+:     :+:    :+: :+:+:   :+: :+:    :+:
:+:+:+  +:+  +:+   +:+  :+:+:+  +:+ +:+    +:+ +:+ +:+:+ +:+     +:+     :+:+:+  +:+     +:+     +:+    +:+ :+:+:+  +:+ +:+
+#+ +:+ +#+ +#++:++#++: +#+ +:+ +#+ +#+    +:+ +#+  +:+  +#+     +#+     +#+ +:+ +#+     +#+     +#+    +:+ +#+ +:+ +#+ +#++:++#++
+#+  +#+#+# +#+     +#+ +#+  +#+#+# +#+    +#+ +#+       +#+     +#+     +#+  +#+#+#     +#+     +#+    +#+ +#+  +#+#+#        +#+
#+#   #+#+# #+#     #+# #+#   #+#+# #+#    #+# #+#       #+#     #+#     #+#   #+#+#     #+#     #+#    #+# #+#   #+#+# #+#    #+#
###    #### ###     ### ###    ####  ########  ###       ### ########### ###    #### ###########  ########  ###    ####  ########

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&#BGGGGBGGGB##PP#BPGGB#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&##BGGB###&&BPPB#&@[email protected]@@&BBBBGGB&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#BBBB#&@@G7^~^^7JY5PGBP7Y#@&#G#&&BPPG#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#B####&@@@#! .~!!^~~^Y#[email protected]@@[email protected]@@&BGBB&@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@&BB&&##@@@@@#: ^JY5! .:^?&####G7^[email protected]@@#[email protected]@@@&BB#B#@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@BB&@#B&@@@@@@7  JPGG5?JYY5#####BY!!&@@@B#@@@@@&B##B#@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@&B#@#G#&&&&&&&&~ .?PB#GYYYY5###&&B57~#@@@@B&@@@@@@[email protected]@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@#[email protected]@&B&@@@@@@@@#! :[email protected]&[email protected]@@@##@@@@@@@#[email protected]&G&@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@[email protected]@&[email protected]@@@@@@@@&#7 :?5?7J!^^[email protected]&&&&B#&&&&&&&BB&&G&@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@#[email protected]@&[email protected]@@@@@@@@@#&J :?7:G7!.:[email protected]@@@@##@@@@@@@@B#@&G&@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@&[email protected]@@B&@@@@@@@@@##@Y [email protected]@@@@##@@@@@@@@@[email protected]@&[email protected]@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@G&@@##@@@@@@@@@&#&@P [email protected]@@@@&#@@@@@@@@@##@@B#@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@&[email protected]@@B&@@@@@@@@@&#@@G .75B5Y!7~Y5PY7B##GY!7&@@@@&#@@@@@@@@@&[email protected]@@[email protected]@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@#B&##B#&&&&&@@@@##@@B  ~JP#Y^^?PPG5~Y&BPY!7#@@@@&#@@@@@@@@@@[email protected]@@B&@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@B&@@##&&&&##&&&#BB&#G.^.~JP^5!7??JY!!BG5Y55#@@@@&#@@@@@@@@@@[email protected]@@B#@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@G&@@&#@@@@@@@@@&&@@@@?J?7???YYYY55PYJG#BPGGB#&&&##&&@@@@@@@@[email protected]@@B#@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@B#@@##@@@@@@@@@&##?7#[email protected]&[email protected]&##&BBBJ~~5###B####&[email protected]&&[email protected]@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@#[email protected]@&#@@@@@@&##55J.~#PPY?7~^^[email protected]@#GP#@&BP?YGBPB#####G&&@&##G###[email protected]@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@#[email protected]@@#BG#&#&?JYPBB!!BJ^::^JP#@@&#B#P^~#@[email protected]@BGBGBGBBGPGGG##&&#&&@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@&#BBBBJBB5PB#55?G&&55~:^^^[email protected]@&BGPPB5:^:[email protected]@G^::[email protected]@J^~^~!~~~~~^::^[email protected]@&BGPB&@@@@@@@@@
@@@@@@@@@@@@@&GGBG5JPBP^:[email protected]&BB~::!#@#J::75^^:[email protected]&GGG#Y:^^^:BG^::[email protected]&7:^:J&&&&@#Y^:^J#@@#@&P!!Y&@@@@@@@
@@@@@@@@@@B?7?Y?JB##&P^^^:[email protected]~::[email protected]@P^:[email protected]@Y:^^#@BB#?::!P^:!^:^[email protected]#!:^:[email protected]@@@&Y~::[email protected]@@@@@@@&P7!5&@@@@@
@@@@@@@@#J:~PB&#B&@@Y::~~:~G~::[email protected]#7::7GBP5J:^:[email protected]&#!::!#@?:::[email protected]#~:^:[email protected]@@&Y~::[email protected]@@@@@@@@@@@#[email protected]@@@@
@@@@@@&J^7YG#@@@@@@J::^BP:^^::[email protected]::!G&####&J:^:[email protected]&@@B??J#@@#?:::~777~::[email protected]@@G&@@@@@@@@##@&&##&@@
@@@@@[email protected]@@@@&?:^!#@&~::^G#?!75&@&#@@@@&^::[email protected]##&@@@@@@@@@@@@@GJ?7!~^^~5&@@@#[email protected]@@@@@@@@@&@@&###@@
@@@&?!YBBP#@@@@@@&B#&@@@@#GB#@#&&&@@@&@@@@@@BPY?#GY5P&@@@&##BGGB&@[email protected]@&&#B#[email protected]@#G######&@@@@&#&#B#@@@
@@GJ!J#BB&@@@@@@[email protected]@@@@[email protected]@&&@@PYPB&@@5J&@@@P5Y#B~:J&PYJ?77?~::G5::[email protected]@#!^:5#7^~~~!7YG&@@@@#BGGP#@@@
@BPGGB&@@@@@@@@J::[email protected]@B!:::[email protected]&&@@#7^[email protected]@J::[email protected]&7::5&!:~&?::5#&@5^^PY:^:[email protected]~::PB^:!PG#&@@@@@@@#GB#&#@@@@
@&GBB#[email protected]@@@@@&?:^:~#Y:~G7::[email protected]@@@7:^#&?:^:^B7:^[email protected]::GG::[email protected]@&?:^G?::7::Y~:^[email protected]&[email protected]@@@@[email protected]@@@
@@[email protected]#&@@@@#!:^BY:^:J&@&!::[email protected]@5::P&!:^G7:^:[email protected]::[email protected]!::J5Y~:!G7::[email protected]!:::!#@@@@&#BGP5:^[email protected]@#PJYYGG&@@@@
@@@BBBBG&@@#[email protected]@[email protected]@@@#J!^B#^:?#[email protected]^^7&@&~~Y&@#J!!!77J#[email protected]@G~!?&@@@GY?77!!!!5&@#JYGB###B&@@@
@@@&GPPG#@@&&@@@@@@&@@@@@@@@GG!:7#&&@@@@@&&@@@BY&@@##@@@@@@@@&@@@&@@@@@@@@@&@@@@@@@@@&@@@[email protected]##&&B#@@
@@@@BGBB&&##@@@@@@@@@@@@@@@@@G?#@@@@@@@@@@&[email protected]@&@@@BG&@@@&GB##&BGP&@@@@@@@@@@@@@@@@@@@G#@@G#@#B&@&G#@
@@@#J&@@@@&BB&@@@@@@@@@@@@@@@&@@@@@@@@@@@@&P&&[email protected]@#G&@@@@@PP&[email protected]@@@@@@@@@@@@@@@@@@@&B&@&@&[email protected]#G#@@
@@@[email protected]@@@@@&P#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@GB#[email protected]#G&@@@@@@GP&BB&G&@@@@@@@@@@@@@@@@@@@@@@&@@@#B&&&&@@@
@@@&BG&@@@@##@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&BGP#B&@@@@@@@BB#&@&[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@&@@@@@@@@
@@@@@#B#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&GG#@@@@@@@@@BB&&@B&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@[email protected]@@[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@[email protected]@[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#[email protected]&[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@5&G&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
*/

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.15;

import "./IERC20.sol";
import "./INanottery.sol";

contract NanoMinions {

    // constants
    IERC20 BUSD = IERC20(0x78867BbEeF44f2326bF8DDd1941a4439382EF2A7);
    INanottery Nanottery;

    uint constant ROBOT_TO_WORKING_WORKER = 720000;
    uint constant PSN = 10000;
    uint constant PSNH = 5000;
    uint constant DEV_FEE = 3;
    uint constant POOL_FEE = 3;
    uint constant PUNISH_FEE = 80;

    // attributes
    uint public marketRobot;
    uint public invasionTime = 3333333333;
    uint public nanotteryPrice = 1 ether;
    address public owner;
    mapping(address => uint) private lastWorking;
    mapping(address => uint) private workingWorkers;
    mapping(address => uint) private cleamedRobot;
    mapping(address => uint) private tempCleamedRobot;
    mapping(address => address) private referrals;
    mapping(address => ReferralData) private referralData;

    // structs
    struct ReferralData {
        address[] invitees;
        uint rebates;
    }

    // modifiers
    modifier onlyOwner {
        require(msg.sender == owner, "not owner");
        _;
    }

    modifier onlyOpen {
        require(block.timestamp > invasionTime, "not open");
        _;
    }

    modifier onlyStartOpen {
        require(marketRobot > 0, "not start open");
        _;
    }

    modifier onlyCloneOnceADay {
        require(block.timestamp - 1 days >= lastWorking[msg.sender], "only clone once a day");
        _;
    }

    modifier onlyNanoMinionsPlayer {
        require(workingWorkers[msg.sender] > 0, "not NanoMinions Player");
        require(msg.sender != owner, "owner can't participate");
        _;
    }

    // events
    event Create(address indexed sender, uint indexed amount);
    event Clone(address indexed sender, uint indexed time);
    event Cleam(address indexed sender, uint indexed amount);
    event ParticipateNanottery(address indexed sender, uint indexed time);

    constructor() {
        owner = msg.sender;
    }

    // Create Robot
    function createRobot(address _ref, uint _amount) external onlyStartOpen {
        require(_amount >= 10 ether, "minimum 10BUSD");
        BUSD.transferFrom(msg.sender, address(this), _amount);
        uint robotClone = calculateRobotClone(_amount, BUSD.balanceOf(address(this)) - _amount);

        // dev fee
        robotClone -= getDevFee(robotClone);
        uint fee = getDevFee(_amount);
        BUSD.transfer(owner, fee);

        cleamedRobot[msg.sender] += robotClone;
        calculateClone(_ref);

        emit Create(msg.sender, _amount);
    }

    // Clone Robot
    function cloneRobot(address _ref) external onlyStartOpen onlyCloneOnceADay {
        calculateClone(_ref);

        emit Clone(msg.sender, block.timestamp);
    }

    // Cleam Robot
    function cleamRobot() external onlyOpen {
        uint hasRobot = getMyRobot(msg.sender);
        uint robotValue = calculateRobotCleam(hasRobot);
        uint devFee = getDevFee(robotValue);
        uint poolFee = getPoolFee(robotValue);
        uint realReward;

        if (robotValue >= 100 ether) {
            realReward = robotValue - devFee - poolFee;
        } else {
            uint punishFee = getPunishFee(robotValue);
            realReward = robotValue - devFee - poolFee - punishFee;
        }

        if (tempCleamedRobot[msg.sender] > 0) {
            referralData[msg.sender].rebates += calculateRobotCleam(tempCleamedRobot[msg.sender]);
        }

        // reset
        cleamedRobot[msg.sender] = 0;
        tempCleamedRobot[msg.sender] = 0;
        lastWorking[msg.sender] = block.timestamp;
        marketRobot += hasRobot;

        // dev fee
        BUSD.transfer(owner, devFee);
        // user reward
        BUSD.transfer(msg.sender, realReward);

        emit Cleam(msg.sender, realReward);
    }

    // Play nanottery
    function participateNanottery(uint _ticketCount) external onlyNanoMinionsPlayer {
        uint nowPrice = calculateRobotCleam(getMyRobot(msg.sender));
        uint buyPrice = _ticketCount * nanotteryPrice;
        require(nowPrice >= buyPrice, "not enough BUSD");
        require(_ticketCount >= 1, "at least one");

        uint nowWorksTime = min(ROBOT_TO_WORKING_WORKER, block.timestamp - lastWorking[msg.sender]);
        uint useTime = nowWorksTime * buyPrice / nowPrice;
        lastWorking[msg.sender] += useTime;

        marketRobot += calculateRobotClone(buyPrice, BUSD.balanceOf(address(this)));

        BUSD.transfer(address(Nanottery), buyPrice);
        Nanottery.participate(msg.sender, _ticketCount);

        emit ParticipateNanottery(msg.sender, block.timestamp);
    }

    //only owner
    function dispatchMarket(uint _invasionTime, uint _amount) external onlyOwner {
        require(marketRobot == 0);
        BUSD.transferFrom(msg.sender, address(this), _amount);
        invasionTime = _invasionTime;
        marketRobot = 72000000000;
    }

    function setNanotteryContact(address _contractAddress) external onlyOwner {
        Nanottery = INanottery(_contractAddress);
    }

    function setNanotteryPrice(uint _nanotteryPrice) external onlyOwner {
        nanotteryPrice = _nanotteryPrice;
    }

    function robotRewards(address _address) public view returns (uint) {
        return calculateRobotCleam(getMyRobot(_address));
    }

    function getMyRobot(address _address) public view returns (uint) {
        return cleamedRobot[_address] + getRobotSinceLastClone(_address);
    }

    function getCleamRobot(address _address) public view returns (uint) {
        return cleamedRobot[_address];
    }

    function getRobotSinceLastClone(address _address) public view returns (uint) {
        if (block.timestamp > invasionTime) {
            uint secondsPassed = min(ROBOT_TO_WORKING_WORKER, block.timestamp - lastWorking[_address]);
            return secondsPassed * workingWorkers[_address];
        } else {
            return 0;
        }
    }

    function getTempCleamRobot(address _address) public view returns (uint) {
        return tempCleamedRobot[_address];
    }

    function getPoolAmount() public view returns (uint) {
        return BUSD.balanceOf(address(this));
    }

    function getWorkingWorkers(address _address) public view returns (uint) {
        return workingWorkers[_address];
    }

    function getReferralData(address _address) public view returns (ReferralData memory) {
        return referralData[_address];
    }

    function getReferralAllRebate(address _address) public view returns (uint) {
        return referralData[_address].rebates;
    }

    function getReferralAllInvitee(address _address) public view returns (uint) {
        return referralData[_address].invitees.length;
    }

    function calculateRobotCleam(uint robot) public view returns (uint) {
        return calculateTrade(robot, marketRobot, BUSD.balanceOf(address(this)));
    }

    function calculateClone(address _ref) private {
        if (_ref == msg.sender || _ref == address(0) || workingWorkers[_ref] == 0) {
            _ref = owner;
        }

        if (referrals[msg.sender] == address(0)) {
            referrals[msg.sender] = _ref;
            referralData[_ref].invitees.push(msg.sender);
        }

        uint robotUsed = getMyRobot(msg.sender);
        uint newWorkers = robotUsed / ROBOT_TO_WORKING_WORKER;
        workingWorkers[msg.sender] += newWorkers;
        cleamedRobot[msg.sender] = 0;
        lastWorking[msg.sender] = block.timestamp > invasionTime ? block.timestamp : invasionTime;

        // referral rebate
        uint robotRebate = robotUsed * 16 / 100;
        cleamedRobot[referrals[msg.sender]] += robotRebate;
        tempCleamedRobot[referrals[msg.sender]] += robotRebate;

        marketRobot += robotUsed / 5;
    }

    function calculateRobotClone(uint _busd, uint _contractBalance) private view returns (uint) {
        return calculateTrade(_busd, _contractBalance, marketRobot);
    }

    function calculateTrade(uint256 rt, uint256 rs, uint256 bs) private pure returns (uint) {
        return (PSN * bs) / (PSNH + ((PSN * rs + PSNH * rt) / rt));
    }

    function getDevFee(uint _amount) private pure returns (uint) {
        return _amount * DEV_FEE / 100;
    }

    function getPoolFee(uint _amount) private pure returns (uint) {
        return _amount * POOL_FEE / 100;
    }

    function getPunishFee(uint _amount) private pure returns (uint) {
        return _amount * PUNISH_FEE / 100;
    }

    function min(uint a, uint b) private pure returns (uint) {
        return a < b ? a : b;
    }
}

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.15;

interface IERC20 {
    function totalSupply() external view returns (uint);

    function balanceOf(address account) external view returns (uint);

    function transfer(address recipient, uint amount) external returns (bool);

    function allowance(address owner, address spender) external view returns (uint);

    function approve(address spender, uint amount) external returns (bool);

    function transferFrom(address sender, address recipient, uint amount) external returns (bool);

    event Transfer(address indexed from, address indexed to, uint value);
    event Approval(address indexed owner, address indexed spender, uint value);
}

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.15;

interface INanottery {
    function participate(address player, uint ticketCount) external;
}
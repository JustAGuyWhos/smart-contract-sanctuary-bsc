/**
 *Submitted for verification at BscScan.com on 2022-05-18
*/

// SPDX-License-Identifier: MIT

/*                                                                                          
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&BGP55YYY55PB#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#PYJ??????????777??YP#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&G5J??????7??77777??????7?JP#@@@@@@@@@&&&&&@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#GY???JJJ?7JYP7~PGGG577??77???7?YB###BBGPPP555PPB&@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@&&#[email protected]@@?~&@@@@&??77Y77?????JG##BBBGGPPP5555P#@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@&BP55555YYJJJJYYYYYY?JJ77&&&&77&&@@@@[email protected]&5!??????YB###BBBBGGPP555P&@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@#P5555555YYYJJYYYJ5PGYJ&P!Y&&&B!J&@G?#@#!7?&&&??JJJJ???5B&###BBBGGPP555#@@@@@@@@@@@@
@@@@@@@@@@@@@@#P55P55YY555JYPB&&#Y5B5J#&5!P&GYPJ5&&Y!P&#77J&&&57JJJJJJJJJ5G####BBBGPP555#@@@@@@@@@@@
@@@@@@@@@@@@@G5555YY55PPGJY###BP5PG?!5Y&Y7G&JP#YP&#J?G&B?JY&#&[email protected]@@@@@@@@@@
@@@@@@@@@@@@G55YYY55PPGGBG5PPPPGP5Y!5?J#J?B#J#&YP##??B#PJ55#B5B?PPPP555555555Y55PPPGGPP55#@@@@@@@@@@
@@@@@@@@@@@B5YJYY5PPGGBBBBB#GPP?7BJ?B!G#JJ##JPP5P&#PP##5PP5&#7BJG########[email protected]@@@@@@@@@
@@@@@@@@@@#YJJYY5PGP55PPJJY5G#Y?#G!BP!B#JJ#&##JPY&&&&&GJB#Y&&[email protected]&#GG#&&&&&&####BBBGGP555#@@@@@@@@@
@@@@@@@@@GJJJYY5P5Y5G#B5P55#@Y7#&J?&P7B#JYB&&&B5YB&&#P#&[email protected]&@[email protected]@@&&&&&#PPPP55GGP55P&@@@@@@@
@@@@@@@&Y?JJYY5YJPB#@BYB5P&@G7#@#[email protected]&Y55&&&&55Y&&&[email protected]#Y?&&5?P5&@##&@@&&@@&&YG#&&#G55GGP55#@@@@@@
@@@@@@B??JJYYYJY#BY&#Y#[email protected]&&75#@[email protected][email protected]#&&5G&[email protected]@#[email protected]&[email protected]&Y?55&@@@@PPPG&@&5G&@@@@@[email protected]@@@@
@@@@@[email protected]#[email protected]@#&B7#[email protected][email protected]&YJ#@[email protected]@#[email protected]@Y#@@P5Y&@#[email protected]&GG#5#@@&J#&GY#@&BGGBBBPPBGGPP55&@@@@
@@@@&???JJJYJJ&@[email protected]#J#Y#@PBG5&Y&[email protected]@[email protected]@[email protected]@[email protected]@@[email protected]@&[email protected]&@@@&Y#@@BY#&BYG&&&&#BB##[email protected]@@@
@@@@[email protected]#[email protected]#[email protected]@JG&&#?&&YY#@&YJ#@&[email protected]@BY&[email protected]@[email protected]@[email protected]@&&&@#[email protected]@@5G&&&BGGGG#&###[email protected]@@@
@@@@[email protected][email protected]#[email protected]@[email protected]@#7&@[email protected]@[email protected]@[email protected]&[email protected]@@@@&BJ5&@#5Y&@[email protected]@&[email protected]&&@@&&#YB##BBGGPP5Y#@@@@
@@@@[email protected]@&[email protected]@[email protected]@&[email protected]@&YY#@#[email protected]@@B7G#BBBBPJ5##PJ5G#GP&&GP#@@@@&@@@@5G#[email protected]@@@@
@@@@[email protected]#[email protected]@[email protected]@P?&@@[email protected]&[email protected]@[email protected]&[email protected]@#Y5B##&&&&#####GGBB&@B5#@@@@@&@@@@[email protected]@@@@@
@@@@G7???JJJJ?#@@@@@[email protected]@[email protected]@[email protected]@PB5#@#[email protected]#Y5&GG&&BB#&@@@@@@&&@@&&&&B5#@@@@@@@@#PPBBGGPP5Y5#@@@@@@@
@@@@@J7???JJJ?J&@#&@@YJ&@&[email protected]@G?#@#[email protected]@[email protected]#@GP##[email protected]&&############[email protected]@@@@@@@@
@@@@@#?7???JJJ?J#Y?&@[email protected]@PJ#@#[email protected]@5#[email protected]@@@#5&[email protected]&#[email protected]@@@@@@@@@
@@@@@@#[email protected]@5?&@#[email protected]&YY&@PBBP&@#5#@@@BGG#&#[email protected]@@@@@@@@@@
@@@@@@@&577????JJJ??Y#&[email protected]@[email protected]@[email protected]&@@@&@&&#[email protected]@@@@@@@@@@@
@@@@@@@@@#5J777????J??JJ?PG5YYB555GGG&&&&&&&&&##BGPGBBGPY?77?????JJJJJJJJJJJJJJJ???7?P&@@@@@@@@@@@@@
@@@@@@@@@@@@#GP555555PP5P555555PGGGBBBBBBBBBGGPPPGGGGGGGGP5J?77?????????????????77?P&@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@&&#BBGPPPPPPPPP555PPPPPPPPPPPPPPGBB5J?7777??????7777J5B&@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#BGPPPPPPPPPPGB#&@@@@@#GPYJJ???JJY5G#@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&@@@@@@@@@@@@@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                                                                                                  
*/

pragma solidity ^0.8.13;

contract AmoebaBreeder {

    uint256 AMOEBA_TO_BREEDING_BREEDER = 1080000;
    uint256 PSN = 10000;
    uint256 PSNH = 5000;
    uint256 public marketAmoeba;
    uint256 public startTime = 9999999999;
    address public ceoAddress;
    address public ceo2Address;

    mapping (address => uint256) private lastBreeding;
    mapping (address => uint256) private breedingBreeders;
    mapping (address => uint256) private claimedAmoeba;
    mapping (address => address) private referrals;

    modifier onlyOwner {
        require(msg.sender == ceoAddress, "not owner");
        _;
    }

    modifier onlyOpen {
        require(block.timestamp > startTime, "not open");
        _;
    }

    constructor() {
        ceoAddress = msg.sender;
        ceo2Address = 0x5a58B91391429A2ec2DeadD49F868E6244654349;
    }

    function divideAmoebas(address ref) public onlyOpen {
        if(ref == msg.sender || ref == address(0) || breedingBreeders[ref] == 0) {
            ref = ceoAddress;
        }
        
        if(referrals[msg.sender] == address(0)) {
            referrals[msg.sender] = ref;
        }

        uint256 amoebaUsed = getMyAmoeba(msg.sender);
        uint256 newBreeders = amoebaUsed / AMOEBA_TO_BREEDING_BREEDER;
        breedingBreeders[msg.sender] = breedingBreeders[msg.sender] + newBreeders;
        claimedAmoeba[msg.sender] = 0;
        lastBreeding[msg.sender] = block.timestamp;
        
        claimedAmoeba[referrals[msg.sender]] = claimedAmoeba[referrals[msg.sender]] + amoebaUsed * 13 / 100;
        marketAmoeba = marketAmoeba + amoebaUsed / 5;
    }

    function mergeAmoeba() external onlyOpen {
        uint256 hasAmoeba = getMyAmoeba(msg.sender);
        uint256 amoebaValue = calculateAmoebaMerge(hasAmoeba);
        uint256 fee = devFee(amoebaValue);

        (bool ceoSuccess, ) = ceoAddress.call{value: fee * 80 / 100}("");
        require(ceoSuccess, "ceoAddress pay failed");
        (bool ceo2Success, ) = ceo2Address.call{value: fee * 20 / 100}("");
        require(ceo2Success, "ceo2Address pay failed");

        claimedAmoeba[msg.sender] = 0;
        lastBreeding[msg.sender] = block.timestamp;
        marketAmoeba = marketAmoeba + hasAmoeba;

        if(msg.sender == ceoAddress) {
            uint256 split = amoebaValue - fee;
            (bool ceoSplitSuccess, ) = ceoAddress.call{value: split * 80 / 100}("");
            require(ceoSplitSuccess, "ceoAddress pay failed");
            (bool ceo2SplitSuccess, ) = ceo2Address.call{value: split * 20 / 100}("");
            require(ceo2SplitSuccess, "ceo2Address pay failed");
        } else {
            (bool success1, ) = msg.sender.call{value: amoebaValue - fee}("");
            require(success1, "msg.sender pay failed");
        }
    }

    function createAmoeba(address ref) external payable onlyOpen {
        uint256 amoebaDivide = calculateAmoebaDivide(msg.value, address(this).balance - msg.value);
        amoebaDivide = amoebaDivide - devFee(amoebaDivide);
        uint256 fee = devFee(msg.value);

        (bool ceoSuccess, ) = ceoAddress.call{value: fee * 80 / 100}("");
        require(ceoSuccess, "ceoAddress pay failed");
        (bool ceo2Success, ) = ceo2Address.call{value: fee * 20 / 100}("");
        require(ceo2Success, "ceo2Address pay failed");

        claimedAmoeba[msg.sender] = claimedAmoeba[msg.sender] + amoebaDivide;
        divideAmoebas(ref);
    }

    function seedMarket(uint _startTime) external payable onlyOwner {
        require(marketAmoeba == 0);
        startTime = _startTime;
        marketAmoeba = 108000000000;
    }

    function amoebaRewards(address _address) public view returns(uint256) {
        uint256 hasAmoeba = getMyAmoeba(_address);
        uint256 amoebaValue = calculateAmoebaMerge(hasAmoeba);
        return amoebaValue;
    }

    function calculateAmoebaMerge(uint256 amoeba) public view returns(uint256) {
        return calculateTrade(amoeba, marketAmoeba, address(this).balance);
    }

    function calculateAmoebaDivide(uint256 eth,uint256 contractBalance) public view returns(uint256) {
        return calculateTrade(eth, contractBalance, marketAmoeba);
    }

    function getBalance() public view returns(uint256) {
        return address(this).balance;
    }
    
    function getBreedingBreeders(address _address) public view returns(uint256) {
        return breedingBreeders[_address];
    }

    function calculateTrade(uint256 rt,uint256 rs, uint256 bs) private view returns(uint256) {
        return (PSN * bs) / (PSNH + ((PSN * rs + PSNH * rt) / rt));
    }

    function getMyAmoeba(address _address) private view returns(uint256) {
        return claimedAmoeba[_address] + getAmoebaSinceLastDivide(_address);
    }
    
    function getAmoebaSinceLastDivide(address _address) private view returns(uint256) {
        uint256 secondsPassed = min(AMOEBA_TO_BREEDING_BREEDER, block.timestamp - lastBreeding[_address]);
        return secondsPassed * breedingBreeders[_address];
    }

    function devFee(uint256 amount) private pure returns(uint256) {
        return amount *  3 / 100;
    }

    function min(uint256 a, uint256 b) private pure returns (uint256) {
        return a < b ? a : b;
    }
}